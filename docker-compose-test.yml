services:
  traefik:
    image: traefik:v3.6.2
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"     # http
      - "8080:8080" # traefik dashboard (api)
    volumes:
      - ./traefik-test/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik-test/dynamic.yml:/etc/traefik/dynamic.yml:ro
      # Mount the plugin source into Traefik's local plugins path (readme recommended path)
      - ./:/plugins-local/src/github.com/ski-company/traefik-xrealip-fixer:ro
    networks:
      - proxy

  whoami1:
    image: traefik/whoami
    container_name: whoami1
    restart: unless-stopped
    expose:
      - "80"
    environment:
      - WHOAMI_NAME=whoami1
      - WHOAMI_PORT_NUMBER=80
    networks:
      - proxy
  
  whoami2:
    image: traefik/whoami
    container_name: whoami2
    restart: unless-stopped
    expose:
      - "80"
    environment:
      - WHOAMI_NAME=whoami2
      - WHOAMI_PORT_NUMBER=80
    networks:
      - proxy

  k6:
    image: grafana/k6:0.53.0
    container_name: k6-benchmark
    restart: no
    profiles: ["bench"]
    depends_on:
      - traefik
      - whoami
    entrypoint: ["k6"]
    command: ["run", "/scripts/k6-benchmark.js"]
    volumes:
      - ./traefik-test/k6-benchmark.js:/scripts/k6-benchmark.js:ro
    environment:
      - TARGET_URL=http://traefik/whoami
      - VUS=20
      - DURATION=30s
    networks:
      - proxy

networks:
  proxy:
    driver: bridge
